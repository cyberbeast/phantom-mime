<html>

<head>
  <script src="http://localhost:8080/socket.io/socket.io.js"></script>
  <script type="text/javascript" src="https://rawgithub.com/craftyjs/Crafty/release/dist/crafty-min.js"></script>
  <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
  <script src="../client/assets/js/game.js"></script>
  <script src="../client/assets/js/components.js"></script>
  <script src="../client/assets/js/scenes.js"></script>
  <script src="../client/assets/js/game_grid.js"></script>
  <style>
      #cr-stage { border:2px solid black; margin:5px auto; color:white }
      </style>
  <script>
    console.log('Loading game...');
    $(function () {
      var turn_local = 'Player1';
      var gameid_local = null;
      //var pObject
      console.log("Establishing socket connection now...");
      var socket = io('/game');
      var myIdentity;

      socket.on('yourIdentity', function (data) {
        myIdentity = data
      })

      socket.emit('gameInit', {
        data: "from Game"
      });

      socket.on('gameInitResponse', function (data) {
        // console.log(data);
        data.identity = myIdentity
        Game.start(socket, data);
        gameid_local = Game.create_players();
        console.log("From game.js: ", turn_local)
      })

      socket.on('newMove', function (data) {
        //get player in previous turn
        var prev_turn = data['player'] === 'Player1' ? 'Player2' : 'Player1';
        var prev_player = Crafty(prev_turn);
        //render their move
        Game.move(prev_player, data['move']);
        var playerPositions = Game.get_status()
        var player1 = Crafty('Player1');
        var player2 = Crafty('Player2');
        console.log(playerPositions)
        console.log(player1.y / 50);
        console.log(playerPositions[1][1]);
        if (player1.x / 50 == playerPositions[1][0] && player1.y / 50 == playerPositions[1][1]) {
          socket.emit('gameServerListener', {
            event: 'endGame',
            data: {
              winner: !(prev_player === player1)

            }
          });
        }
        if (player2.x / 50 == playerPositions[0][0] && player2.y / 50 == playerPositions[0][1]) {
          socket.emit('gameServerListener', {
            event: 'endGame',
            data: {
              winner: !(prev_player === player2)

            }
          });
        }
        //Collision Detection
        if(player1.x == prev_player.x && player1.y == prev_player.y && prev_player !==player1)
        {
          console.log("player2 hit player1");
          socket.emit('gameServerListener', {
            event: 'endGame',
            data: {
              winner: (prev_player === player1)

            }
          });
          Game.collision_call("Player 2")

        }
        if(player2.x == prev_player.x && player2.y == prev_player.y && prev_player !==player2)
        {
          console.log("player1 hit player2");
          socket.emit('gameServerListener', {
            event: 'endGame',
            data: {
              winner: (prev_player === player2)

            }
          });
          Game.collision_call("Player 1")

        }

        //toggle the turn again
        turn_local = data['player'];
        console.log('After rendering move:', turn_local);


      });

      $(document).keydown(function (e) {
        console.log(turn_local)
        //get player entity whose turn it is
        var current_player = Crafty(turn_local);
        //render move if the current use is the current player
        if (myIdentity === current_player.identity) {
          Game.move(current_player, e.keyCode);
          var playerPositions = Game.get_status()
          var player1 = Crafty('Player1');
          var player2 = Crafty('Player2');
          console.log(playerPositions)
          console.log(player1.y / 50);
          console.log(playerPositions[1][1]);
          if (player1.x / 50 == playerPositions[1][0] && player1.y / 50 == playerPositions[1][1]) {
            socket.emit('gameServerListener', {
              event: 'endGame',
              data: {
                winner: (current_player === player1)

              }
            });
          }
          if (player2.x / 50 == playerPositions[0][0] && player2.y / 50 == playerPositions[0][1]) {
            socket.emit('gameServerListener', {
              event: 'endGame',
              data: {
                winner: (current_player === player2)

              }
            });
          }
          //Collision detection
          if(player1.x == current_player.x && player1.y == current_player.y && current_player ===player2)
          {
            console.log("player2 hit player1");
            socket.emit('gameServerListener', {
            event: 'endGame',
            data: {
              winner: !(current_player === player1)

            }
          });
          Game.collision_call("Player 2")
          }
          if(player2.x == current_player.x && player2.y == current_player.y && current_player ===player1)
          {
            console.log("player1 hit player2");
            socket.emit('gameServerListener', {
            event: 'endGame',
            data: {
              winner: !(current_player === player2)

            }
          });
          Game.collision_call("Player 1")
          }
          //toggle turn after move is rendered
          turn_local = turn_local === 'Player1' ? 'Player2' : 'Player1';
          //emit to other player recent move
          socket.emit('gameServerListener', {
            event: 'newMove',
            data: {
              player: turn_local,
              move: e.keyCode,
              game: gameid_local

            }
          });

        }
      });

      socket.on('success', function (data) {
        console.log("REGISTERED with: " + data)
      })
    });
  </script>
</head>

<body>
  <div>
  </div>
</body>

</html>